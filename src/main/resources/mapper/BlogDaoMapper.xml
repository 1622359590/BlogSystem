<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.duan.blogos.dao.blog.BlogDao">

    <sql id="allField">
        SELECT
            ${alias}.id,
            ${alias}.blogger_id,
            ${alias}.category_ids,
            ${alias}.label_ids,
            ${alias}.state,
            ${alias}.title,
            ${alias}.content,
            ${alias}.summary,
            ${alias}.release_date,
            ${alias}.nearest_modify_date,
            ${alias}.key_words,
            ${alias}.word_count
    </sql>

    <select id="listBlog" resultType="Blog">
        <include refid="allField">
            <property name="alias" value="b"/>
        </include>
        FROM blog b
        WHERE state=#{status} AND b.id=#{bloggerId}
    </select>

    <select id="listBlogWithLimit" resultType="Blog">
        <include refid="allField">
            <property name="alias" value="b"/>
        </include>
        FROM blog b
        WHERE state=#{status} AND b.id = #{bloggerId}
        LIMIT #{offset}, #{rows}
    </select>

    <select id="listAll" resultType="Blog">
        <include refid="allField">
            <property name="alias" value="b"/>
        </include>
        FROM blog b
    </select>

    <update id="update" parameterType="Blog">
        UPDATE blog
        <set>
            <if test="bloggerId != null">
                blogger_id=#{bloggerId},
            </if>
            <if test="categoryIds != null">
                category_ids=#{categoryIds},
            </if>
            <if test="labelIds != null">
                label_ids=#{labelIds},
            </if>
            <if test="state != null">
                state=#{state},
            </if>
            <if test="title != null">
                title=#{title},
            </if>
            <if test="content != null">
                content=#{content},
            </if>
            <if test="summary != null">
                summary=#{summary},
            </if>
            <if test="releaseDate != null">
                release_date=#{releaseDate},
            </if>

            nearest_modify_date=NOW(),

            <if test="keyWords != null">
                key_words=#{keyWords},
            </if>
            <if test="wordCount != null">
                word_count=#{wordCount},
            </if>
        </set>
        <where>
            id=#{id}
        </where>

    </update>

    <delete id="delete">
        DELETE FROM blog
        WHERE id = #{id}
    </delete>

    <insert id="insert" parameterType="Blog">
        INSERT INTO blog (
            id,
            blogger_id,
            category_ids,
            label_ids,
            state,
            title,
            content,
            summary,
            release_date,
            nearest_modify_date,
            key_words,
            word_count
        ) VALUE (
            NULL,
            #{bloggerId},
            ifnull(#{categoryIds}, ''),
            ifnull(#{labelIds}, ''),
            ifnull(#{state}, 0),
            #{title},
            #{content},
            #{summary},
            NOW(),
            NOW(),
            #{keyWords},
            ifnull(#{wordCount}, 0)
        )
    </insert>

    <select id="listAllCategoryAndLabel" resultType="Blog">
        SELECT
            b.id,
            b.category_ids,
            b.label_ids
        FROM blog b
        WHERE b.blogger_id = #{bloggerId} AND b.state = #{status};
    </select>

    <select id="listBlogByBlogIds" resultType="Blog" parameterType="list">
        <include refid="allField">
            <property name="alias" value="b"/>
        </include>
        FROM blog b WHERE b.id IN
        <foreach collection="ids"
                 item="id"
                 open="("
                 separator=","
                 close=")">
            #{id}
        </foreach>
        AND b.state=#{status} LIMIT #{offset},#{rows}
    </select>

</mapper>